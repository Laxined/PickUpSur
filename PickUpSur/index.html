<!DOCTYPE html> 
 <html lang="cs"> 
 <head> 
     <meta charset="UTF-8"> 
     <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
     <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
     <title>Lax's journey around the world</title> 
 </head> 
 <style> 
     body { 
         font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif; 
     } 
  
      #myCanvas { 
         display: block; 
         margin: 19px auto 0px auto; 
         margin-top: 0; 
     }
  
     h1 { 
      text-align: center; 
       font-size: 350%; 
     } 
  
     h2 { 
         text-align: center; 
         font-size: 200%; 
         margin-top: 0%; 
     } 
 </style> 
 <body onload="alert('To see Controls hold Q.')"> 
     <h2>Inventory Status: <span id="Inventory"></span></h2> 
     <div class="mid"> 
     <canvas id="myCanvas" width="1200" height="600" style="border:5px solid black"> 
         Your browser does not support the canvas element. 
     </canvas> 
     </div> 
 </body> 
 <script> 
       var canvas = document.getElementById("myCanvas");     /////////////////////////////////////////dodelat grafiku, animace
       var ctx = canvas.getContext("2d");                    /////////////////////////////////////////udelat vice levelu, udelat zivoty
  
  
       window.addEventListener('keydown', this.onKey, false); 
       window.addEventListener('keyup', this.onKeyUp, false); 
  
       let inventoryElement = document.getElementById("Inventory"); 
  
       let playerSK = newImage("player");
       let npcSkin = newImage("Lucio");
       let Background1 = newImage("bg1");
       let tree = newImage("strom");
       let Background2 = newImage("bg2");
       let cactus = newImage("kaktus");
       
       let E = false; 
       let EPush = false; 
  
       let Inventory = []; 
       let npcStatus = 0;   //0 -- 1.dialog, 2 -- druhý dialog, 3 ---- další level 
       let talk = 0; 

       let quests = [];
  
       let Q = false; 
       let QPush = false; 
       let R = false;
       let RPush = false;
       let levl = 1; 
  
       let player = {x:712, y:75, sx:32, sy:65, spX:0, spY:0, sk:playerSK, fr:false}; 
  
       let level = { 
         tutorial: { 
             background: Background1, 
              npc: [ 
                 {x:50, y:75, sx:32, sy:65, sk:npcSkin, name:"Lucio", LengthOfTalk2:3, talking: false, speech: [ 
                             { q: "", d: ""}, 
                             { q: "-- Hi, My name is Lucio, but you know that already.", d: "-- Oh, you really did it! Whisper:'I didn't really expect that.'"}, 
                             { q: "-- Our car has unfortunatly crashed here.", d: "-- Now we can go! When you're ready, come here and press'E'."}, 
                             { q: "-- So now, we need to get some wood for repair."}, 
                             { q: "-- You go get it and I'll be here and watch the car."}, 
                             { q: "-- When you'll find it, bring it here to me, Good Luck."}, 
                 ],  
                 draw: function() { 
                     ctx.drawImage(this.sk, this.x, this.y); 
                 }, 
                 after1Dialog: function() {
                    activeQuest.shift();
                    activeQuest.push({tl:"Find and bring wood"});
                    for (item of active.items) {
                        item.take = true;
                     }} 
             },], 
         enemies: [], 
         items: [], 
         walls: [
                newWall(410, 340, 50, 120, tree),
                newWall(20, 500, 50, 120, tree),
                newWall(600, 420, 50, 120, tree),
                newWall(200, 290, 50, 120, tree),
                newWall(1000, 20, 50, 120, tree),
                newWall(400, 40, 50, 120, tree),
             ],
         }, 
  
         one: { 
             background: Background2, 
             npc: [ 
                 {x:50, y:75, sx:32, sy:65, sk:npcSkin, name:"Lucio", LengthOfTalk2:4, talking: false, speech: [ 
                         { q: "", d: ""}, 
                         { q: "-- Damn it! We didn't get far and our car is already broken again!", d: "-- Aaa, you are finally back!"}, 
                         { q: "-- This time we have no fuel.", d: "-- You got it! Nice!"}, 
                         { q: "-- If I am right, there is a fuel station down there.", d: "-- We can go to the next location!"}, 
                         { q: "-- Even though i would like to go there, you already have experience."}, 
                         { q: "-- So, be aware of wild stuff and uh... Good Luck"} 
                 ],  
                 draw: function() { 
                     ctx.drawImage(this.sk, this.x, this.y); 
                 }, 
                 after1Dialog: function() {
                    activeQuest.shift();
                    activeQuest.push({tl:"Find and bring Fuel"});
                    for (item of active.items) {
                        item.take = true;
                     }
                 }
             }], 
             enemies: [  
                     newEnemy(0, 300, 83, 50, false, 0, "black", 2, 1), 
                     newEnemy(1000, 300, 83, 50, false, 0, "black", 2, 1), 
                     newEnemy(1100, 300, 83, 50, false, 0, "black", 2, 1), 
                     newEnemy(250, 300, 83, 50, false, 0, "black", 2, 1), 
                     newEnemy(500, 300, 83, 50, false, 0, "black", 2, 1), 
                     newEnemy(890, 300, 83, 50, false, 0, "black", 2, 1), 
                 ], 
             items: [],
             walls: [
                newWall(20, 500, 50, 120, cactus),
                newWall(200, 180, 50, 120, cactus),
                newWall(900, 150, 50, 120, cactus),
                newWall(500, 450, 50, 120, cactus),
             ],
         }, 
         two: { 
             background: Background1, 
             npc: [ 
                 {x:50, y:75, sx:32, sy:65, sk:npcSkin, name:"Lucio", LengthOfTalk2:6, talking: false, speech: [ 
                             { q: "", d: ""}, 
                             { q: "-- I don't know, how are you, but i am very hungry.", d: "-- Aaaa, There you are. Where have you been?"}, 
                             { q: "-- Luckily for me, ugh, I mean, us, of course,", d: "-- I am waiting here for like i don't know, hours."}, 
                             { q: "-- There is an old building with supplies.", d: "-- But, did you found something?"}, 
                             { q: "-- Go there and bring here something", d: "-- Nice, give it to me, i almost died of hunger."}, 
                             { q: "-- But be cautious, i don't want anything to happen to you.", d: "-- Thank you very much, now, we can contionue our journey."}, 
                             { q: "-- But be quick, i am starting starving."}
                 ], 
                 draw: function() { 
                     ctx.drawImage(this.sk, this.x, this.y); 
                 },
                 after1Dialog: function() {
                    activeQuest.shift();
                    activeQuest.push({tl:"Find and bring Suplies"});
                    for (item of active.items) {
                        item.take = true;
                     }
                 }
             }], 
                 enemies: [ 
                     newEnemy(400, 500, 83, 50, false, Math.PI * 2 * Math.random(), "black", 5, 2), 
                     newEnemy(400, 500, 83, 50, false, Math.PI * 2 * Math.random(), "black", 5, 2), 
                     newEnemy(400, 500, 83, 50, false, Math.PI * 2 * Math.random(), "black", 5, 2), 
                 ], 
             items: [],
             walls: [
                    newWall(410, 340, 50, 120, tree),
             ],
         } 
       } 
  
       level.tutorial.items.push(newItem(1000, 500, 50, 50, "brown", "Wood", true));   //pushování itemů do items
       level.tutorial.items.push(newItem(600, 300, 50, 50, "blue", "Water", false));
       level.one.items.push(newItem(1000, 500, 50, 50, "green", "Fuel", true)); 
       level.two.items.push(newItem(1000, 500, 50, 50, "orange", "Supplies", true)); 
  
       let active = level.one; 
  
       let sentence = ""; 

       let activeQuest = [];
       let talkToNpc = {al:"19px Lucida sans", y:88, tl:"Talk to Lucio."};
  
       let controls = [ 
         {x:1190, y:35, al:"30px Lucida sans", tl:"Controls"}, 
         {x:1190, y:60, al:"19px Lucida sans", tl:"Movement - WASD"}, 
         {x:1190, y:88, al:"19px Lucida sans", tl:"To Interaction press 'E'"}, 
         {x:1190, y:116, al:"19px Lucida sans", tl:"To pick up something press 'E'"}, 
         {x:1190, y:142, al:"19px Lucida sans", tl:"You can have only 1 thing in Inventory."}, 
         {x:1190, y:170, al:"19px Lucida sans", tl:"To see your quest hold 'R'."}
       ] 

       let lengthOfControls = 400; //19(font)x19(idk) = 364 == 400
       let heightOfControls = controls.length * 32;
  
         function newEnemy(x, y, sx, sy, fr, ang, sk, sp, type) {            //type 1 - stillEnemy, type 2 - random enemy 
             return {x:x, y:y, sx:sx, sy:sy, fr:fr, ang:ang, sk:sk, sp:sp, type:type,   
                     draw: function() { 
                         ctx.fillStyle = this.sk; 
                          ctx.fillRect(this.x, this.y, this.sx, this.sy); 
                     }}}; 
  
         function newItem(x, y, sx, sy, sk, name, right) { 
             return {x:x, y:y, sx:sx, sy:sy, sk:sk, name:name, right:right, place:false, take:false,
             draw: function() {
                 ctx.fillStyle = this.sk;
                ctx.fillRect(this.x, this.y, this.sx, this.sy) }
             } 
         }

         function newWall(x, y, sx, sy, sk) {
            return {
                x:x, y:y, sx:sx, sy:sx, sk:sk, hitbox: [
                ], draw: function() {
                     ctx.drawImage(sk, x, y);
                }, push: function() {
                    HitboxPush(x, y, sx, sy);
                }
            };
         }

         function newHitbox(x, y, sx, sy, dir) {
            if (dir == 1) {
            return {x:x, y:y, sx:1, sy:sy, collis: function() {
                        if (collision(player.x, this.x, player.sx, this.sx, 0) && collision(player.y, this.y, player.sy, this.sy, 0)) {
                                player.x -= player.spX;
                        }}}};
            if (dir == 2) {
             return {x:x, y:y, sx:sx, sy:1, collis: function() {
                        if (collision(player.x, this.x, player.sx, this.sx, 0) && collision(player.y, this.y, player.sy, this.sy, 0)) {
                                player.y -= player.spY;
                        }}}};   
            if (dir == 3) {
               return {x:x + sx, y:y, sx:1, sy:sy, collis: function() {
                        if (collision(player.x, this.x, player.sx, this.sx, 0) && collision(player.y, this.y, player.sy, this.sy, 0)) {
                                player.x -= player.spX;
                        }}}};
            if (dir == 4) {
               return {x:x, y:y + sy, sx:sx, sy:1, collis: function() {
                        if (collision(player.x, this.x, player.sx, this.sx, 0) && collision(player.y, this.y, player.sy, this.sy, 0)) {
                                player.y -= player.spY;
                        }}}};        
        }

        function newImage(name) {
            let img = new Image();
            img.src = "Images/" + name + ".png";
            return img;
        }
  
       function onKey(event) {           //klávesy 
             if (event.keyCode == 65 || event.keyCode == 37) { 
                if (Inventory.length == 1) {
                    player.spX = -2;
                } else {player.spX = -4; }
             } 
             if (event.keyCode == 68 || event.keyCode == 39) { 
                if (Inventory.length == 1) {
                    player.spX = 2;
                } else {player.spX = 4; } 
             } 
             if (event.keyCode == 87 || event.keyCode == 38) { 
                if (Inventory.length == 1) {
                    player.spY = -2;
                } else {player.spY = -4; } 
             } 
             if (event.keyCode == 83 || event.keyCode == 40) { 
                if (Inventory.length == 1) {
                    player.spY = 2;
                } else {player.spY = 4; } 
             } 
  
             if (event.code == "KeyE") { 
                 E = true; 
             } 
  
             if (event.code == "KeyQ") { 
                 Q = true; 
             } 

             if (event.code == "KeyR") {
                R = true;
             }
         } 
  
         function onKeyUp() {        //klávesy 2 
                 if (event.code == "KeyW" || event.code == "KeyS" || event.code == "ArrowUp" || event.code == "ArrowDown" ) { 
                     player.spY = 0; 
                 } 
                 if ( event.code == "KeyA" || event.code == "KeyD"||  event.code == "ArrowLeft" || event.code == "ArrowRight") { 
                     player.spX = 0; 
                 } 
  
                 if (event.code == "KeyE") { 
                     E = false; 
                     EPush = false; 
                 } 
  
                 if (event.code == "KeyQ") { 
                     Q = false; 
                     QPush = false; 
                 } 

                 if (event.code == "KeyR") {
                    R = false;
                    RPush = false;
                 }
             } 
  
     function draw() { 
         ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight); 
         ctx.drawImage(active.background, 0, 0); 
  
         enemyMovement();  //hybani random enemy  
         InventoryControl();  // inv veci 
         collisionWithEnemy();  //kolize 
         placeItem(); //pokladani objektu
  
         if (player.fr == false) {
            player.x += player.spX;            //hýbání hráče 
            player.y += player.spY;
         } 
  
        ctx.drawImage(player.sk, player.x, player.y); //vykreslování hráče 
  
        if (player.y <= 0){ 
            player.y -= player.spY; 
         } 
        if (player.y + player.sy >= canvas.height) { 
            player.y -= player.spY; 
         } 
        if (player.x <= 0) { 
            player.x -= player.spX; 
         } 
        if (player.x + player.sx >= canvas.width) { 
            player.x -= player.spX ; 
         } 

         for (enemy of active.enemies) {  //vykreslovani enemy
                 enemy.draw(); 
        }  
  
        for (item of active.items) {    //vykreslování materiálu  
             item.draw();
        } 
             
        for (let i = 0; i < active.walls.length; i++) {    //vykreslovani zdi a kolize s hracem
           active.walls[i].draw();
           active.walls[i].push();
            for (let j = 0; j < active.walls[i].hitbox.length; j++) {
                active.walls[i].hitbox[j].collis();
            }
        }

        if (Inventory.length == 1) {
            Inventory[0].x = player.x;
            Inventory[0].y = player.y;
        }

        for (npc of active.npc) {
            npc.draw();
        }

        talkingField(); //pole na mluveni
        QuestListField(); //questy
        Controls();  //controls 
        CooperatingWithNPC(); //npc veci
  
         if (levl == 0) active = level.tutorial; 
         if (levl == 1) active = level.one; 
         if (levl == 2) active = level.two; 
     } 
  
     function CooperatingWithNPC() { 
         for (npc of active.npc) {     //mluvení 1 
         if (npcStatus == 0 && npc.talking == true) { 
             if (talk < npc.speech.length) sentence = npc.speech[talk].q; player.fr = true;
             if (talk == npc.speech.length) {sentence = npc.speech[0].q; talk = 0; player.fr = false;
                npc.after1Dialog();    
            }  
         }

         if (activeQuest.length == 0) {  //davani questu
            activeQuest.push(talkToNpc);
         }

         if (npc.talking == true) text("18px Lucida Sans", "Black", "left", npc.x, npc.y - 10, sentence) 
  
         if (npcStatus == 2 && npc.talking == true) {               //mluvení 2 
             if (talk < npc.LengthOfTalk2) {sentence = npc.speech[talk].d; player.fr = true;}
               if (talk == npc.LengthOfTalk2) {sentence = npc.speech[0].d; player.fr = false; talk = 0; npcStatus = 3;}
          }     
  
  
          if (npcStatus == 3 && E == true && EPush == false) { 
             if (collision(player.x, npc.x, player.sx, npc.sx, 0) && collision(player.y, npc.y, player.sy, npc.sy, 0)) {   //konec levelu 
                 levl++; 
                 npcStatus = 0; 
                 talk = 0;
                 player.x = 400;
                 player.y = 75;
             } 
          } 
  
         if (E == true && EPush == false ) {  //mluvení 
             if (collision(player.x, npc.x, player.sx, npc.sx, 0) && collision(player.y, npc.y, player.sy, npc.sy, 0)) { 
             talk++ ; 
             EPush = true; 
             } 
         } 

         if (talk > 0 && collision(player.x, npc.x, player.sx, npc.sx, 0) && collision(player.y, npc.y, player.sy, npc.sy, 0)) { 
            npc.talking = true;
         } else {
            npc.talking = false;
         }
  
         if (E == true && Inventory.length == 1) {  //odevzdání materiálu 
             if (collision(player.x, npc.x, player.sx, npc.sx, 0) && collision(player.y, npc.y, player.sy, npc.sy, 0)) {  
                if (Inventory[0].right == true) {
                 npcStatus = 2;
                 Inventory.shift(); 
                 activeQuest.shift();
             } }
         } 
     }} 

     function placeItem() {
        for (npc of active.npc) {
        if (E == true && Inventory.length == 1 && Inventory[0].place == true) {
            if (!collision(player.x, npc.x, player.sx, npc.sx, 0) || !collision(player.y, npc.y, player.sy, npc.sy, 0)) {
                Inventory[0].place = false;
                active.items.push(Inventory[0]);
                Inventory.shift();
                setTimeout(() => active.items[active.items.length - 1].take = true, 500);
            }
        }}
     }

     function talkingField() {
        for (npc of active.npc) {
            if (npc.talking) {
                ctx.fillStyle = "white"
                ctx.fillRect(npc.x - 15, npc.y - 50, 615, 50);

                ctx.lineWidth = 3;
                ctx.strokeStyle = "Black";
                ctx.strokeRect(npc.x - 15, npc.y - 50, 615, 50);
                text("25px Belanosima", "black", "left", npc.x - 10, npc.y - 30, npc.name);
            }
        }}
  
     function InventoryControl() {               //ovládání inventáře 
         if (Inventory.length == 1) {       
             inventoryElement.innerHTML = Inventory[0].name;
         } 
  
         if (Inventory.length == 0) {          
             inventoryElement.innerHTML = " You have empty bag.";
         }

         for (i = 0; i < active.items.length; i++) {
            if (E == true && Inventory.length == 0 && active.items[i].take == true) {                       //sebrání materiálu 
                    if (collision(player.x, active.items[i].x, player.sx, active.items[i].sx, 0) && collision(player.y, active.items[i].y, player.sy, active.items[i].sy, 0)) {
                     active.items[i].take = false;   
                     Inventory.push(active.items[i]) 
                     active.items.splice(i, 1);
                     setTimeout(() => Inventory[0].place = true, 500);
                  } 
              }}} 
  
     function Controls() { //napsané controls 
         if (Q == true && R == false) { 
                ctx.fillStyle = "white"
                ctx.fillRect(canvas.width - lengthOfControls, 0, lengthOfControls, heightOfControls);

                ctx.lineWidth = 5;
                ctx.strokeStyle = "Black";
                ctx.strokeRect(canvas.width - lengthOfControls, 0, lengthOfControls, heightOfControls);
             for (control of controls) { 
                 text(control.al, "black", "right", control.x, control.y, control.tl); 
          } 
         } 
     } 

     function QuestListField() {
        if (R == true && Q == false) {
                ctx.fillStyle = "white"
                ctx.fillRect(800, 0, 400, 192);

                ctx.lineWidth = 5;
                ctx.strokeStyle = "Black";
                ctx.strokeRect(800, 0, 400, 192);
                text("30px Lucida sans", "black", "right", 1190, 35, "Your quests:"); 
            if (activeQuest.length > 0) {
                for (quest of activeQuest) {
                    text("19px Lucida sans", "black", "right", 1190, 88, quest.tl);
                }
            } else {
                text("25px Lucida sans", "black", "right", 1190, 60, "You don't have any quests!"); 
            }
        }
     }
  
     function text(font, cl, align, x, y, text) { //text v canvasu 
         ctx.font = font; 
         ctx.fillStyle = cl; 
         ctx.textAlign = align; 
         ctx.fillText(text, x, y); 
     } 
  
     function collisionWithEnemy() { //kolize s enemy 
         for (enemy of active.enemies) { 
             if (collision(player.x, enemy.x, player.sx, enemy.sx, 0) && collision(player.y, enemy.y, player.sy, enemy.sy, 0)) { 
                 alert("Game Over"); 
             } 
         }} 

     function HitboxPush(x, y, sx, sy) {
        for (wall of active.walls) {
        for (let i = 1; i < 5; i++) {
                wall.hitbox.push(newHitbox(x, y, sx, sy, i))
        }}
     }
  
     function collision(obj1, obj2, sz1, sz2, dis) {  //kolize 
             let midd1 = obj1 + sz1 / 2; 
                         let midd2 = obj2 + sz2 / 2; 
                         let min = (sz1 + sz2 + dis) / 2; 
                         let diff = Math.abs (midd1 - midd2); 
                         return diff < min; 
     } 
  
     function enemyMovement() {      //hýbání enemy 
         for (enemy of active.enemies) { 
             if (!enemy.fr) { 
                if (enemy.type == 2) {
             enemy.x += Math.cos(enemy.ang) * enemy.sp; 
             enemy.y += Math.sin(enemy.ang) * enemy.sp; 
  
             if (Math.random() < 0.05) enemy.ang = Math.random() * Math.PI * 2; 
  
             if (enemy.x <= 0) enemy.ang = Math.PI - enemy.ang; 
             if (enemy.x + enemy.sx >= canvas.width) enemy.ang = Math.PI - enemy.ang; 
  
             if (enemy.y <= 150) enemy.ang =  -enemy.ang; 
             if (enemy.y + enemy.sy >= canvas.height) enemy.ang = -enemy.ang; 
            }
             if (enemy.type == 1) { 
             enemy.x += enemy.sp; 
             if (enemy.x >= canvas.width) enemy.x = 0; 
            } 
        }}} 
     setInterval(draw, 15); 
 </script> 
 </html>
